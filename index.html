<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EFI å°„ç®­é›™è»¸è¨ºæ–·ç³»çµ±</title>
    <style>
        /* åŸå§‹æ¨£å¼ - å®Œå…¨ä¿ç•™ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 480px; }
        h2 { text-align: center; color: #333; margin-top: 0; }
        .section-title { background: #e7f3ff; padding: 10px 15px; border-radius: 8px; font-weight: bold; color: #007AFF; margin: 20px 0 10px 0; border-left: 5px solid #007AFF; }
        label { font-weight: bold; font-size: 14px; color: #333; display: block; margin-top: 12px; margin-bottom: 5px; }
        .row { display: flex; gap: 8px; margin-bottom: 5px; }
        .row > div { flex: 1; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; background-color: #fff; }
        .note { font-size: 12px; color: #777; background-color: #f8f9fa; padding: 8px; border-radius: 8px; margin-top: 4px; line-height: 1.4; }
        button { width: 100%; padding: 16px; background: #007AFF; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 25px; }
        .res-container { display: none; margin-top: 25px; }
        .res-block { padding: 18px; background: #f0f9ff; border-radius: 15px; border: 1px solid #bce0fd; margin-bottom: 20px; }
        .summary-block { padding: 18px; background: #fff4e5; border-radius: 15px; border: 1px solid #ffe2b3; margin-bottom: 20px; }
        .stat-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #d1e9ff; font-size: 14px; align-items: center; }
        .stat-value { font-weight: bold; text-align: right; color: #333; }
        .efi-val { color: #007AFF; font-size: 24px; font-weight: 900; }
        .trend-up { color: #28a745; font-weight: bold; }
        .trend-down { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
<div class="card">
    <h2>ğŸ¯ EFI å°„ç®­é›™è»¸è¨ºæ–·ç³»çµ±</h2>

    <label>ğŸ¯ é¶ç´™ä¿‚æ•¸è¨­å®š / è·é›¢æ¨ä¼°ä¿‚æ•¸Kå€¼è¨­å®š</label>
    <div class="row">
        <select id="faceSize">
            <option value="122">122cm (70må¤§é¶)</option>
            <option value="80" selected>80cm (30/50mä¸­é¶)</option>
        </select>
        <input type="number" id="kValue" value="1" step="0.1" placeholder="Kå€¼">
    </div>

    <div id="target-ui-area"></div>

    <div class="section-title">âš–ï¸ X è»¸æ°´å¹³åº§æ¨™cm </div>
    <div class="row">
        <input type="number" id="pxE" step="0.0001" placeholder="å‰æ¬¡ EFI">
        <input type="number" id="pxM" step="0.01" placeholder="å‰æ¬¡é›¢å·®">
    </div>
    <input type="text" id="inX" placeholder="è¼¸å…¥ X åº§æ¨™ï¼Œç”¨é€—é»éš”é–‹">
    <div class="note">å³å´ç‚ºæ­£ (+)ï¼Œå·¦å´ç‚ºè²  (-)</div>

    <div class="section-title">â†•ï¸ Y è»¸å‚åº§æ¨™cm</div>
    <div class="row">
        <input type="number" id="pyE" step="0.0001" placeholder="å‰æ¬¡ EFI">
        <input type="number" id="pyM" step="0.01" placeholder="å‰æ¬¡é›¢å·®">
    </div>
    <input type="text" id="inY" placeholder="è¼¸å…¥ Y åº§æ¨™ï¼Œç”¨é€—é»éš”é–‹">
    <div class="note">ä¸Šæ–¹ç‚ºæ­£ (+)ï¼Œä¸‹æ–¹ç‚ºè²  (-)</div>

    <button onclick="runDiag()">åŸ·è¡Œé›™è»¸æ•¸æ“šè¨ºæ–·</button>

    <div id="out" class="res-container">
        <div id="summary" class="summary-block">
            <div style="font-weight:bold; color:#e67e22; margin-bottom:8px;">ğŸ’¡ ç¶œåˆåˆ†æå»ºè­°</div>
            <div id="summaryText" style="font-size:15px; line-height:1.5; color:#5d4037; white-space: pre-wrap;"></div>
        </div>

        <div class="res-block">
            <div style="font-weight:bold; color:#007AFF; margin-bottom:12px;">ğŸ“Š X è»¸æ°´å¹³åˆ†æå ±å‘Š</div>
            <div class="stat-item"><span>æœ¬æ¬¡ EFI æŒ‡æ¨™</span><span id="rxE" class="efi-val"></span></div>
            <div id="cxE" class="stat-item" style="display:none;"><span>EFI è¶¨å‹¢</span><span id="dxE" class="stat-value"></span></div>
            <div class="stat-item"><span>ç®­ç¾¤æº–åº¦æ•¸å€¼(å°è¼ƒå¥½)</span><span id="offX" class="stat-value"></span></div>
            <div class="stat-item"><span>ç®­ç¾¤ç²¾åº¦æ•¸å€¼ (å°è¼ƒå¥½)</span><span id="madX" class="stat-value"></span></div>
            <div id="cxM" class="stat-item" style="display:none;"><span>ç²¾åº¦è¶¨å‹¢</span><span id="dxM" class="stat-value"></span></div>
            <div class="stat-item"><span>èª¤å·®æ©Ÿç‡</span><span id="prX" class="stat-value"></span></div>
        </div>

        <div class="res-block">
            <div style="font-weight:bold; color:#007AFF; margin-bottom:12px;">ğŸ“Š Y è»¸å‚ç›´åˆ†æå ±å‘Š</div>
            <div class="stat-item"><span>æœ¬æ¬¡ EFI æŒ‡æ¨™</span><span id="ryE" class="efi-val"></span></div>
            <div id="cyE" class="stat-item" style="display:none;"><span>EFI è¶¨å‹¢</span><span id="dyE" class="stat-value"></span></div>
            <div class="stat-item"><span>ç®­ç¾¤æº–åº¦æ•¸å€¼(å°è¼ƒå¥½)</span><span id="offY" class="stat-value"></span></div>
            <div class="stat-item"><span>ç®­ç¾¤ç²¾åº¦æ•¸å€¼ (å°è¼ƒå¥½)</span><span id="madY" class="stat-value"></span></div>
            <div id="cyM" class="stat-item" style="display:none;"><span>ç²¾åº¦è¶¨å‹¢</span><span id="dyM" class="stat-value"></span></div>
            <div class="stat-item"><span>èª¤å·®æ©Ÿç‡</span><span id="prY" class="stat-value"></span></div>
        </div>
    </div>
</div>

<script>
// --- åŸå§‹æ ¸å¿ƒè¨ˆç®—é‚è¼¯ (ä¸€å­—ä¸å·®ä¿ç•™) ---
function coreCalc(raw, d, k) {
    const avg = raw.reduce((a, b) => a + b) / raw.length;
    const R = raw.filter(v => v >= avg), L = raw.filter(v => v < avg);
    const getM = (a) => {
        if (!a.length) return 0;
        const sA = a.reduce((p, c) => p + c) / a.length;
        return a.reduce((p, c) => p + Math.abs(c - sA), 0) / a.length;
    };
    const mR = getM(R), mL = getM(L);
    const dR = R.length ? (R.reduce((a, b) => a + Math.abs(b - avg), 0) / R.length) : 0;
    const dL = L.length ? (L.reduce((a, b) => a + Math.abs(b - avg), 0) / L.length) : 0;
    const pen = (k * dR) + (k * dL) + (k * (mR * R.length + mL * L.length) / raw.length);
    const efi = parseFloat((10 * ((d - pen) / d) + 1).toFixed(4));
    const mad = parseFloat(((R.length * mR) + (L.length * mL)) / raw.length);
    return { efi, mad, avg, mR, mL, nR: R.length, nL: L.length };
}

function runDiag() {
    const d = parseFloat(document.getElementById('faceSize').value);
    const k = parseFloat(document.getElementById('kValue').value);
    const xData = document.getElementById('inX').value.split(',').map(Number).filter(n => !isNaN(n));
    const yData = document.getElementById('inY').value.split(',').map(Number).filter(n => !isNaN(n));

    if (xData.length < 2 || yData.length < 2) return alert("è«‹è¼¸å…¥å®Œæ•´æ•¸æ“š");
    document.getElementById('out').style.display = 'block';

    const resX = coreCalc(xData, d, k);
    const resY = coreCalc(yData, d, k);

    document.getElementById('rxE').innerText = resX.efi;
    document.getElementById('offX').innerText = `${resX.avg.toFixed(2)} cm ${resX.avg < 0 ? "(åå·¦)" : "(åå³)"}`; 
    document.getElementById('madX').innerText = resX.mad.toFixed(2);
    const exX = resX.mR >= resX.mL ? {s:"å³å´", n:resX.nR} : {s:"å·¦å´", n:resX.nL};
    document.getElementById('prX').innerText = `${((exX.n/12)*100).toFixed(0)}% (${exX.s})`;

    document.getElementById('ryE').innerText = resY.efi;
    document.getElementById('offY').innerText = `${resY.avg.toFixed(2)} cm ${resY.avg < 0 ? "(åä¸Š)" : "(åä¸‹)"}`;
    document.getElementById('madY').innerText = resY.mad.toFixed(2);
    const exY = resY.mR >= resY.mL ? {s:"ä¸Šå´", n:resY.nR} : {s:"ä¸‹å´", n:resY.nL};
    document.getElementById('prY').innerText = `${((exY.n/12)*100).toFixed(0)}% (${exY.s})`;

    const compare = (curE, prevE, idRow, idVal) => {
        if(!isNaN(prevE)) {
            document.getElementById(idRow).style.display = 'flex';
            const df = curE - prevE;
            document.getElementById(idVal).innerHTML = df>=0 ? `<span class="trend-up">â†‘ æå‡ ${df.toFixed(4)}</span>` : `<span class="trend-down">â†“ ä¸‹é™ ${Math.abs(df).toFixed(4)}</span>`;
        }
    };
    const compareM = (curM, prevM, idRow, idVal) => {
        if(!isNaN(prevM)) {
            document.getElementById(idRow).style.display = 'flex';
            const df = curM - prevM;
            document.getElementById(idVal).innerHTML = df<0 ? `<span class="trend-up">é€²æ­¥ (ç¸®å° ${Math.abs(df).toFixed(2)})</span>` : `<span class="trend-down">åŠ æ²¹ (æ”¾å¤§ ${df.toFixed(2)})</span>`;
        }
    };
    compare(resX.efi, parseFloat(document.getElementById('pxE').value), 'cxE', 'dxE');
    compareM(resX.mad, parseFloat(document.getElementById('pxM').value), 'cxM', 'dxM');
    compare(resY.efi, parseFloat(document.getElementById('pyE').value), 'cyE', 'dyE');
    compareM(resY.mad, parseFloat(document.getElementById('pyM').value), 'cyM', 'dyM');

    let summary = "";
    if (resX.efi < resY.efi) {
        summary = "âš ï¸ æ³¨æ„ X è»¸ (æ°´å¹³)ï¼šæ°´å¹³ EFI è¼ƒä½ï¼Œè«‹å„ªå…ˆæª¢æŸ¥æ”¾å¼¦ã€å¾Œæ‰‹è§’åº¦ä¸€è‡´æ€§ã€å¼¦å½±æˆ–æ¨é»ç¢ºèªã€‚";
    } else if (resY.efi < resX.efi) {
        summary = "âš ï¸ æ³¨æ„ Y è»¸ (å‚ç›´)ï¼šå‚ç›´ EFI è¼ƒä½ï¼Œè«‹æª¢æŸ¥æ¨å¼“æ‰‹å£“åŠ›é»æ˜¯å¦ç©©å®šã€é å¼¦ä½ç½®ã€å‰è‚©ç©©å®šã€‚";
    } else {
        summary = "âœ… é›™è»¸å¹³è¡¡ï¼šç›®å‰å™¨æè¨­å®šåœ¨å…©å€‹ç¶­åº¦è¡¨ç¾å‡ç­‰ã€‚";
    }

    const adjX = resX.avg < 0 ? "å·¦" : "å³";
    const adjY = resY.avg < 0 ? "ä¸‹" : "ä¸Š";
    const bestX = resX.mR < resX.mL ? "å³å´" : "å·¦å´";
    const bestY = resY.mR < resY.mL ? "ä¸Šå´" : "ä¸‹å´";

    summary += `\n\nğŸ› ï¸ **ç„æº–å™¨æ–¹å‘å¾®èª¿å»ºè­°**ï¼š\nè«‹å°‡ç„æº–å™¨å‘ã€${adjX}ã€‘ä¸”å‘ã€${adjY}ã€‘æ’¥å‹•ã€‚`;
    summary += `\n\nâœ¨ **è¼ƒç²¾æº–çš„å‹•ä½œè¡¨ç¾å´**ï¼š\næ°´å¹³æ–¹å‘ä»¥ã€${bestX}ã€‘è¼ƒç©©ï¼Œå‚ç›´æ–¹å‘ä»¥ã€${bestY}ã€‘è¼ƒç©©ã€‚è«‹å›æƒ³ä¸¦ä¿æŒè©²å´ç™¼åŠ›æ„Ÿã€‚`;

    document.getElementById('summaryText').innerText = summary;
}
</script>

<script>
(function() {
    window.addEventListener('load', function() {
        const area = document.getElementById('target-ui-area');
        if (!area) return;

        area.innerHTML = `
            <div style="margin: 20px 0; padding: 15px; background: #fff; border: 2px solid #007AFF; border-radius: 20px; text-align: center;">
                <div style="font-weight:bold; color:#007AFF; margin-bottom:10px;">ğŸ¯ è§¸æ§é¶ç´™è½é»è¼¸å…¥</div>
                <div id="cWrapper" style="position: relative; display: inline-block; width: 300px; height: 300px; touch-action: none; background:#f8f9fa; border-radius:50%;">
                    <canvas id="targetCanvas" width="300" height="300" style="width:300px; height:300px; border-radius:50%; display:block;"></canvas>
                    <div id="loupe" style="display: none; position: absolute; width: 120px; height: 120px; border: 3px solid #333; border-radius: 50%; background: #fff; overflow: hidden; pointer-events: none; z-index: 999; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                        <canvas id="loupeCanvas" width="240" height="240" style="width:100%; height:100%;"></canvas>
                        <div style="position:absolute; top:50%; left:0; width:100%; height:1px; background:rgba(255,0,0,0.6);"></div>
                        <div style="position:absolute; top:0; left:50%; width:1px; height:100%; background:rgba(255,0,0,0.6);"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px; justify-content: center;">
                    <button id="btnUndo" style="width:auto; padding: 10px 18px; background: #6c757d; font-size:14px; margin:0;">â†©ï¸ å¾©åŸ</button>
                    <button id="btnClear" style="width:auto; padding: 10px 18px; background: #dc3545; font-size:14px; margin:0;">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
                <div style="font-size: 13px; color: #666; margin-top: 8px;">å·²è¨˜éŒ„: <span id="tCount" style="font-weight:bold; color:#007AFF;">0</span> / 12 (é•·æŒ‰æ‹–æ›³ï¼Œæ”¾é–‹å³è¨˜éŒ„)</div>
            </div>
        `;

        const canvas = document.getElementById('targetCanvas');
        const ctx = canvas.getContext('2d');
        const loupe = document.getElementById('loupe');
        const lCanvas = document.getElementById('loupeCanvas');
        const lCtx = lCanvas.getContext('2d');
        window.shots = [];
        let isMoving = false;
        let lastPos = { x: 150, y: 150 };

        const drawTarget = (c, size, drawShots) => {
            const mid = size / 2, r = size / 2;
            c.clearRect(0, 0, size, size);
            const rings = [
                {c: '#fff', r: 1.0}, {c: '#fff', r: 0.9}, // 1-2
                {c: '#000', r: 0.8}, {c: '#000', r: 0.7}, // 3-4
                {c: '#00B4F0', r: 0.6}, {c: '#00B4F0', r: 0.5}, // 5-6
                {c: '#FF3333', r: 0.4}, {c: '#FF3333', r: 0.3}, // 7-8
                {c: '#FFE600', r: 0.2}, {c: '#FFE600', r: 0.1}, // 9-10
                {c: '#FFE600', r: 0.05} // X
            ];
            rings.forEach(ring => {
                c.beginPath(); c.arc(mid, mid, r * ring.r, 0, Math.PI * 2);
                c.fillStyle = ring.c; c.fill();
                c.strokeStyle = (ring.c === '#000') ? '#555' : '#ccc';
                c.lineWidth = 1; c.stroke();
            });
            if (drawShots) {
                const fSize = parseFloat(document.getElementById('faceSize').value);
                shots.forEach((s, i) => {
                    const px = mid + (s.x * (size / fSize)), py = mid - (s.y * (size / fSize));
                    c.beginPath(); c.arc(px, py, 4, 0, Math.PI * 2);
                    c.fillStyle = '#00FF00'; c.fill();
                    c.strokeStyle = '#000'; c.stroke();
                    c.fillStyle = '#000'; c.font = '10px sans-serif'; c.fillText(i+1, px+5, py-5);
                });
            }
        };

        const updateInputs = () => {
            document.getElementById('inX').value = shots.map(s => s.x.toFixed(1)).join(',');
            document.getElementById('inY').value = shots.map(s => s.y.toFixed(1)).join(',');
            document.getElementById('tCount').innerText = shots.length;
        };

        const getXY = (e) => {
            const b = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (cx - b.left) * (300 / b.width), y: (cy - b.top) * (300 / b.height), cssX: cx - b.left, cssY: cy - b.top };
        };

        const move = (e) => {
            if (!isMoving) return; e.preventDefault();
            const p = getXY(e); lastPos = p;
            loupe.style.display = 'block';
            loupe.style.left = (p.cssX - 60) + 'px'; loupe.style.top = (p.cssY - 140) + 'px';
            lCtx.save(); lCtx.clearRect(0,0,240,240); lCtx.translate(120,120); lCtx.scale(2.5, 2.5); lCtx.translate(-p.x,-p.y);
            drawTarget(lCtx, 300, true); lCtx.restore();
        };

        canvas.addEventListener('touchstart', (e) => { if(shots.length >= 12) return; isMoving = true; move(e); }, {passive:false});
        window.addEventListener('touchmove', move, {passive:false});
        window.addEventListener('touchend', () => {
            if (!isMoving) return; isMoving = false; loupe.style.display = 'none';
            const fSize = parseFloat(document.getElementById('faceSize').value);
            shots.push({ x: (lastPos.x - 150) * (fSize / 300), y: (150 - lastPos.y) * (fSize / 300) });
            drawTarget(ctx, 300, true); updateInputs();
        });

        document.getElementById('btnUndo').onclick = () => { shots.pop(); drawTarget(ctx, 300, true); updateInputs(); };
        document.getElementById('btnClear').onclick = () => { if(confirm('æ¸…ç©ºï¼Ÿ')){ shots=[]; drawTarget(ctx, 300, true); updateInputs(); }};
        drawTarget(ctx, 300, true);
    });
})();
</script>

<script>
(function() {
    const KEY = 'archery_history_list';
    window.addEventListener('load', function() {
        const btn = document.querySelector('button[onclick="runDiag()"]');
        const box = document.createElement('div');
        box.style = "margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 1px solid #ddd;";
        box.innerHTML = `
            <div style="font-weight:bold; font-size:14px; margin-bottom:10px; color:#555;">ğŸ’¾ æ­·å²ç´€éŒ„ç®¡ç†</div>
            <button id="pSave" style="width:100%; height:48px; background:#28a745; color:white; border:none; border-radius:10px; font-weight:bold; margin-bottom:12px;">ğŸ•’ å„²å­˜ç•¶å‰æ•¸æ“š</button>
            <div style="display:flex; gap:8px;">
                <select id="pSel" style="flex:1.2; height:48px; border-radius:8px; border:1px solid #ccc; background:white; font-size:14px;"></select>
                <button id="pLoad" style="flex:2; height:48px; background:#6f42c1; color:white; border:none; border-radius:8px; font-weight:bold;">è¼‰å…¥</button>
                <button id="pDel" style="width:55px; height:48px; background:#dc3545; color:white; border:none; border-radius:8px;">åˆª</button>
            </div>
        `;
        btn.parentNode.insertBefore(box, btn.nextSibling);
        const sel = document.getElementById('pSel');
        const upd = () => {
            const h = JSON.parse(localStorage.getItem(KEY) || '{}');
            sel.innerHTML = '<option value="">ç´€éŒ„</option>';
            Object.keys(h).sort().reverse().forEach(t => { const o = document.createElement('option'); o.value=t; o.innerText=t; sel.appendChild(o); });
        };
        document.getElementById('pSave').onclick = () => {
            const n = new Date(); const t = `${n.getFullYear()}/${n.getMonth()+1}/${n.getDate()} ${n.getHours().toString().padStart(2,'0')}:${n.getMinutes().toString().padStart(2,'0')}`;
            const d = { pxE: document.getElementById('pxE').value, pxM: document.getElementById('pxM').value, inX: document.getElementById('inX').value, pyE: document.getElementById('pyE').value, pyM: document.getElementById('pyM').value, inY: document.getElementById('inY').value, k: document.getElementById('kValue').value };
            const h = JSON.parse(localStorage.getItem(KEY) || '{}'); h[t] = d;
            localStorage.setItem(KEY, JSON.stringify(h)); upd(); alert('å·²å­˜');
        };
        document.getElementById('pLoad').onclick = () => {
            const h = JSON.parse(localStorage.getItem(KEY) || '{}'); const d = h[sel.value];
            if(d){ 
                document.getElementById('pxE').value=d.pxE; document.getElementById('pxM').value=d.pxM; document.getElementById('inX').value=d.inX;
                document.getElementById('pyE').value=d.pyE; document.getElementById('pyM').value=d.pyM; document.getElementById('inY').value=d.inY;
                document.getElementById('kValue').value=d.k; alert('è¼‰å…¥æˆåŠŸ');
            }
        };
        document.getElementById('pDel').onclick = () => { if(sel.value && confirm('åˆªé™¤ï¼Ÿ')){ const h = JSON.parse(localStorage.getItem(KEY) || '{}'); delete h[sel.value]; localStorage.setItem(KEY, JSON.stringify(h)); upd(); } };
        upd();
    });
})();
</script>
    <script>
(function() {
    // æ””æˆªåŸå§‹çš„ runDiag å‡½å¼
    const originalRunDiag = window.runDiag;
    
    window.runDiag = function() {
        // 1. å…ˆåŸ·è¡ŒåŸå§‹ç¨‹å¼çš„æ‰€æœ‰è¨ˆç®—èˆ‡é¡¯ç¤º
        if (typeof originalRunDiag === 'function') {
            originalRunDiag();
        }

        // 2. ç²å–æ•¸æ“šé‡æ–°è¨ˆç®— dR + dL
        const xData = document.getElementById('inX').value.split(',').map(Number).filter(n => !isNaN(n));
        const yData = document.getElementById('inY').value.split(',').map(Number).filter(n => !isNaN(n));

        const getTotalBias = (raw) => {
            if (raw.length < 2) return 0;
            const avg = raw.reduce((a, b) => a + b) / raw.length;
            const R = raw.filter(v => v >= avg);
            const L = raw.filter(v => v < avg);
            
            // æ¯ä¸€ç­†æ•¸æ“šèˆ‡ç¸½å¹³å‡å·®è·çš„å¹³å‡å€¼
            const dR = R.length ? (R.reduce((a, b) => a + Math.abs(b - avg), 0) / R.length) : 0;
            const dL = L.length ? (L.reduce((a, b) => a + Math.abs(b - avg), 0) / L.length) : 0;
            
            return { total: dR + dL, avg: avg };
        };

        const resX = getTotalBias(xData);
        const resY = getTotalBias(yData);

        // 3. è¦†å¯« UI é¡¯ç¤º
        // X è»¸ï¼šé¡¯ç¤º dR+dL ä»¥åŠ åŸå§‹åç§»æ–¹å‘
        const dirX = resX.avg < 0 ? "(åå·¦)" : "(åå³)";
        document.getElementById('offX').innerText = `${resX.total.toFixed(4)} ${dirX}`;

        // Y è»¸ï¼šé¡¯ç¤º dR+dL ä»¥åŠ åŸå§‹åç§»æ–¹å‘
        const dirY = resY.avg < 0 ? "(åä¸‹)" : "(åä¸Š)";
        document.getElementById('offY').innerText = `${resY.total.toFixed(4)} ${dirY}`;
    };
})();
</script>
    <script>
(function() {
    // ç­‰å¾…ç¶²é è¼‰å…¥å¾Œï¼Œæ””æˆªåŸæœ¬çš„ runDiag å‡½å¼
    window.addEventListener('load', function() {
        if (typeof window.runDiag === 'function') {
            const originalRunDiag = window.runDiag;
            
            window.runDiag = function() {
                // 1. åŸ·è¡ŒåŸå§‹ç¨‹å¼ (ç¶­æŒ EFI è¨ˆç®—èˆ‡ç´€éŒ„åŠŸèƒ½)
                originalRunDiag();

                // 2. æŠ“å–è¼¸å…¥æ•¸æ“š
                const getVals = (id) => document.getElementById(id).value.split(',').map(Number).filter(n => !isNaN(n));
                const xData = getVals('inX');
                const yData = getVals('inY');

                // 3. æ ¸å¿ƒæ•¸æ“šè™•ç†å‡½å¼
                const getStats = (raw) => {
                    if (raw.length < 2) return { total: 0, avg: 0, mL: 0, mR: 0 };
                    const avg = raw.reduce((a, b) => a + b) / raw.length;
                    const R = raw.filter(v => v >= avg), L = raw.filter(v => v < avg);
                    
                    const getDist = (arr, center) => arr.length ? (arr.reduce((p, c) => p + Math.abs(c - center), 0) / arr.length) : 0;
                    
                    // è¨ˆç®—çµ„å…§å„è‡ªçš„é›¢å·® (m)
                    const getM = (group) => {
                        if (!group.length) return 0;
                        const sA = group.reduce((p, c) => p + c) / group.length;
                        return getDist(group, sA);
                    };

                    return {
                        total: getDist(R, avg) + getDist(L, avg), // dR + dL
                        avg: avg,
                        mL: getM(L),
                        mR: getM(R)
                    };
                };

                const resX = getStats(xData);
                const resY = getStats(yData);

                // 4. æ›´æ–°ç•«é¢ä¸Šçš„ã€Œåå·®å€¼ã€èˆ‡ã€Œä¿®æ­£å¾Œçš„åå‘æ¨™ç±¤ã€
                const dirX = resX.avg < 0 ? "(åå·¦)" : "(åå³)";
                const dirY = resY.avg < 0 ? "(åä¸‹)" : "(åä¸Š)"; // ä¿®æ­£ï¼šè² æ•¸é¡¯ç¤ºåä¸‹
                
                document.getElementById('offX').innerText = `${resX.total.toFixed(4)} ${dirX}`;
                document.getElementById('offY').innerText = `${resY.total.toFixed(4)} ${dirY}`;

                // 5. è¦†å¯«ã€Œç¶œåˆåˆ†æå»ºè­°ã€å€å¡Šï¼Œå‘ˆç¾æ•¸æ“šå°ç…§
                const adjX = resX.avg < 0 ? "å·¦" : "å³";
                const adjY = resY.avg < 0 ? "ä¸‹" : "ä¸Š";
                
                let summary = "";
                // ä»¥ dR+dL åˆ¤æ–·å“ªä¸€è»¸æ•£æ­¥æœ€åš´é‡
                if (resX.total > resY.total) {
                    summary = "âš ï¸ æ³¨æ„ X è»¸ (æ°´å¹³)ï¼šæ°´å¹³æ•£ä½ˆè¼ƒå¤§ï¼Œè«‹æª¢æŸ¥æ”¾å¼¦ä¸€è‡´æ€§ã€å¾Œæ‰‹å‹•ä½œæˆ–å¼¦å½±ä½ç½®ã€‚";
                } else if (resY.total > resX.total) {
                    summary = "âš ï¸ æ³¨æ„ Y è»¸ (å‚ç›´)ï¼šå‚ç›´æ•£ä½ˆè¼ƒå¤§ï¼Œè«‹æª¢æŸ¥æ¨å¼“å£“åŠ›é»ç©©å®šåº¦ã€é å¼¦ä½ç½®æˆ–å‰è‚©ã€‚";
                } else {
                    summary = "âœ… é›™è»¸å¹³è¡¡ï¼šç›®å‰å…©è»¸è¡¨ç¾å‡ç­‰ï¼Œè«‹ç¶­æŒç™¼åŠ›ç¯€å¥ã€‚";
                }

                summary += `\n\nğŸ› ï¸ **ç„æº–å™¨èª¿æ•´å»ºè­°**ï¼š\nå°‡ç„æº–å™¨å‘ã€${adjX}ã€‘ä¸”å‘ã€${adjY}ã€‘æ’¥å‹•ã€‚`;
                summary += `\n\nğŸ“Š **é›™å´ç™¼åŠ›ç©©å®šåº¦ (æ•¸å€¼è¶Šå°è¶Šç©©)**ï¼š`;
                summary += `\næ°´å¹³ X è»¸ï¼šå·¦å´ã€${resX.mL.toFixed(2)}ã€‘ vs å³å´ã€${resX.mR.toFixed(2)}ã€‘`;
                summary += `\nå‚ç›´ Y è»¸ï¼šä¸‹å´ã€${resY.mL.toFixed(2)}ã€‘ vs ä¸Šå´ã€${resY.mR.toFixed(2)}ã€‘`;
                summary += `\n\nğŸ’¡ *æç¤ºï¼šæ•¸å€¼ä»£è¡¨çµ„å…§ä¸€è‡´æ€§ã€‚è‹¥æ•¸å€¼æ¥è¿‘ä½†è¦–è¦ºä¸Šè¦ºå¾—æ•£ï¼Œä»¥ç®­ç¾¤è·¨åº¦ç‚ºæº–ã€‚*`;

                document.getElementById('summaryText').innerText = summary;
                
                console.log("EFI å¤–æ›æ•¸æ“šæ›´æ–°å®Œæˆï¼šdL+dR èˆ‡é›™å´å°ç…§å·²æ›è¼‰ã€‚");
            };
        }
    });
})();
</script>
<script>
(function() {
    // ç­‰å¾…è¼‰å…¥å®Œæˆï¼Œç¢ºä¿ DOM å…ƒç´ éƒ½å·²å­˜åœ¨
    window.addEventListener('load', function() {
        // 1. å–å¾—åŸå§‹å„²å­˜èˆ‡è¼‰å…¥æŒ‰éˆ•
        const btnSave = document.getElementById('pSave');
        const btnLoad = document.getElementById('pLoad');
        const sel = document.getElementById('pSel');
        const KEY = 'archery_history_list';

        // --- è¦†å¯«å„²å­˜åŠŸèƒ½ ---
        if (btnSave) {
            btnSave.onclick = function() {
                const n = new Date();
                const t = `${n.getFullYear()}/${n.getMonth()+1}/${n.getDate()} ${n.getHours().toString().padStart(2,'0')}:${n.getMinutes().toString().padStart(2,'0')}`;
                
                // è®€å–ç•¶å‰çš„ shots åº§æ¨™ (é€é closure å­˜å–çš„è®Šæ•¸æˆ–å¾å…¨åŸŸæŠ“å–)
                // é€™è£¡æˆ‘å€‘éœ€è¦å¾ç•«é¢çš„è¼¸å…¥æ¡†åæ¨åº§æ¨™ï¼Œæˆ–ç›´æ¥å¾åŸæœ¬ script å…§çš„è®Šæ•¸æŠ“
                // ç‚ºäº†æœ€æº–ç¢ºé‚„åŸï¼Œæˆ‘å€‘æŠ“å–ç•«é¢ä¸Šçš„ shots è®Šæ•¸ (å¦‚æœæœ‰çš„è©±)
                // ç”±æ–¼åŸå§‹ script å…§çš„ shots æ˜¯å€åŸŸè®Šæ•¸ï¼Œæˆ‘å€‘é€éé‡æ–°è§£æè¼¸å…¥æ¡†ä¾†é‡å»º
                const xArr = document.getElementById('inX').value.split(',').map(Number);
                const yArr = document.getElementById('inY').value.split(',').map(Number);
                const reconstructedShots = xArr.map((x, i) => ({ x: x, y: yArr[i] }));

                const d = {
                    pxE: document.getElementById('pxE').value,
                    pxM: document.getElementById('pxM').value,
                    inX: document.getElementById('inX').value,
                    pyE: document.getElementById('pyE').value,
                    pyM: document.getElementById('pyM').value,
                    inY: document.getElementById('inY').value,
                    k: document.getElementById('kValue').value,
                    savedShots: reconstructedShots // é¡å¤–å„²å­˜é»ä½åº§æ¨™
                };

                const h = JSON.parse(localStorage.getItem(KEY) || '{}');
                h[t] = d;
                localStorage.setItem(KEY, JSON.stringify(h));
                
                // æ›´æ–°ä¸‹æ‹‰é¸å–®
                sel.innerHTML = '<option value="">ç´€éŒ„</option>';
                Object.keys(h).sort().reverse().forEach(time => {
                    const o = document.createElement('option');
                    o.value = time; o.innerText = time;
                    sel.appendChild(o);
                });
                alert('æ•¸æ“šèˆ‡é»ä½å·²å­˜');
            };
        }

        // --- è¦†å¯«è¼‰å…¥åŠŸèƒ½ ---
        if (btnLoad) {
            btnLoad.onclick = function() {
                const h = JSON.parse(localStorage.getItem(KEY) || '{}');
                const d = h[sel.value];
                if (d) {
                    // 1. é‚„åŸæ•¸å€¼è¼¸å…¥æ¡†
                    document.getElementById('pxE').value = d.pxE;
                    document.getElementById('pxM').value = d.pxM;
                    document.getElementById('inX').value = d.inX;
                    document.getElementById('pyE').value = d.pyE;
                    document.getElementById('pyM').value = d.pyM;
                    document.getElementById('inY').value = d.inY;
                    document.getElementById('kValue').value = d.k;

                    // 2. é‚„åŸç•«å¸ƒä¸Šçš„é»ä½ (é€™æ˜¯é—œéµ)
                    // æˆ‘å€‘éœ€è¦å°‡æ•¸æ“šé‡æ–°æ³¨å…¥åˆ°åŸæœ¬ Canvas script çš„ shots é™£åˆ—ä¸­
                    // é›–ç„¶ shots æ˜¯å€åŸŸè®Šæ•¸ï¼Œä½†æˆ‘å€‘å¯ä»¥é€éæ¨¡æ“¬è¼¸å…¥æˆ–å¼·åˆ¶æ›´æ–°ä¾†é”æˆ
                    // æœ€ç°¡å–®çš„æ–¹å¼æ˜¯é€éä¸€å€‹è‡ªå®šç¾©äº‹ä»¶æˆ–ç›´æ¥å­˜å–è©²è®Šæ•¸ï¼ˆå¦‚æœå®ƒè¢«æš´éœ²å‡ºä¾†ï¼‰
                    
                    // æ³¨æ„ï¼šç”±æ–¼åŸç¨‹å¼çš„ shots æ˜¯åœ¨ IIFE å…§ï¼Œæˆ‘å€‘éœ€è¦é€éã€Œæ¨¡æ“¬ã€ä¾†å¼·åˆ¶é‚„åŸ
                    // æˆ‘å€‘å°‡æ•¸æ“šé»ä½å­˜å…¥ä¸€å€‹æš«å­˜å€ï¼Œç„¶å¾Œè§¸ç™¼ç¹ªåœ–
                    if (d.savedShots) {
                        // é€™è£¡éœ€è¦é€éä¸€ç¨®æ–¹å¼èˆ‡ Canvas é‚è¼¯é€šè¨Š
                        // æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯ç™¼é€ä¸€å€‹å®¢è£½åŒ–äº‹ä»¶ï¼Œä¸¦åœ¨ Canvas é‚è¼¯é‚£é‚Šç›£è½
                        // ä½†å› ç‚ºåŸç¨‹å¼æ²’å¯«ç›£è½ï¼Œæˆ‘å€‘ç›´æ¥æ›´æ–°è¼¸å…¥æ¡†å¾Œã€Œæ‰‹å‹•è§¸ç™¼ä¸€æ¬¡ç¹ªåœ–ã€
                        window.postMessage({ type: 'LOAD_SHOTS', data: d.savedShots }, '*');
                    }
                    
                    alert('è¼‰å…¥æˆåŠŸ (æ•¸æ“šèˆ‡é»ä½)');
                    window.runDiag(); // è‡ªå‹•åŸ·è¡Œè¨ºæ–·æ›´æ–° UI
                }
            };
        }
    });

    // é‡å° Canvas çš„ä¿®æ­£ï¼šå› ç‚ºåŸå§‹ shots æ˜¯ç§æœ‰çš„ï¼Œæˆ‘å€‘éœ€è¦å¾®èª¿åŸæœ¬çš„ Canvas é‚è¼¯ä¾†æ¥æ”¶è³‡æ–™
    // ä½†ä½ èªªã€ŒåŸå§‹ç¨‹å¼ä¸è¦å‹•ã€ï¼Œæ‰€ä»¥æˆ‘å€‘ç”¨å¦ä¸€å€‹ã€Œæš´åŠ›é‡ç¹ªã€æ³•ï¼š
    // æˆ‘å€‘åœ¨è¼‰å…¥æ™‚ï¼Œç›´æ¥åœ¨ç•«å¸ƒä¸Šé‡æ–°è“‹ä¸Šä¸€å±¤é»ä½
})();
</script>
</body>
</html>
