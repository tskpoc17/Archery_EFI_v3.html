<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EFI å°„ç®­é›™è»¸è¨ºæ–·ç³»çµ±</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 480px; }
        h2 { text-align: center; color: #333; margin-top: 0; }
        .section-title { background: #e7f3ff; padding: 10px 15px; border-radius: 8px; font-weight: bold; color: #007AFF; margin: 20px 0 10px 0; border-left: 5px solid #007AFF; }
        label { font-weight: bold; font-size: 14px; color: #333; display: block; margin-top: 12px; margin-bottom: 5px; }
        .row { display: flex; gap: 8px; margin-bottom: 5px; }
        .row > div { flex: 1; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; background-color: #fff; }
        .note { font-size: 12px; color: #777; background-color: #f8f9fa; padding: 8px; border-radius: 8px; margin-top: 4px; line-height: 1.4; }
        button { width: 100%; padding: 16px; background: #007AFF; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 25px; }
        .res-container { display: none; margin-top: 25px; }
        .res-block { padding: 18px; background: #f0f9ff; border-radius: 15px; border: 1px solid #bce0fd; margin-bottom: 20px; }
        .summary-block { padding: 18px; background: #fff4e5; border-radius: 15px; border: 1px solid #ffe2b3; margin-bottom: 20px; }
        .stat-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #d1e9ff; font-size: 14px; align-items: center; }
        .stat-value { font-weight: bold; text-align: right; color: #333; }
        .efi-val { color: #007AFF; font-size: 24px; font-weight: 900; }
        .trend-up { color: #28a745; font-weight: bold; }
        .trend-down { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
<div class="card">
    <h2>ğŸ¯ EFI å°„ç®­é›™è»¸è¨ºæ–·ç³»çµ±</h2>

    <label>ğŸ¯ é¶ç´™ä¿‚æ•¸è¨­å®š / è·é›¢æ¨ä¼°ä¿‚æ•¸Kå€¼è¨­å®š</label>
    <div class="row">
        <select id="faceSize">
            <option value="122">122cm (70må¤§é¶)</option>
            <option value="80" selected>80cm (30/50mä¸­é¶)</option>
        </select>
        <input type="number" id="kValue" value="1" step="0.1" placeholder="Kå€¼">
    </div>

    <div class="section-title">âš–ï¸ X è»¸æ°´å¹³åº§æ¨™cm </div>
    <div class="row">
        <input type="number" id="pxE" step="0.0001" placeholder="å‰æ¬¡ EFI">
        <input type="number" id="pxM" step="0.01" placeholder="å‰æ¬¡é›¢å·®">
    </div>
    <input type="text" id="inX" placeholder="è¼¸å…¥ X åº§æ¨™ï¼Œç”¨é€—é»éš”é–‹">
    <div class="note">å³å´ç‚ºæ­£ (+)ï¼Œå·¦å´ç‚ºè²  (-)</div>

    <div class="section-title">â†•ï¸ Y è»¸å‚åº§æ¨™cm</div>
    <div class="row">
        <input type="number" id="pyE" step="0.0001" placeholder="å‰æ¬¡ EFI">
        <input type="number" id="pyM" step="0.01" placeholder="å‰æ¬¡é›¢å·®">
    </div>
    <input type="text" id="inY" placeholder="è¼¸å…¥ Y åº§æ¨™ï¼Œç”¨é€—é»éš”é–‹">
    <div class="note">ä¸Šæ–¹ç‚ºæ­£ (+)ï¼Œä¸‹æ–¹ç‚ºè²  (-)</div>

    <button onclick="runDiag()">åŸ·è¡Œé›™è»¸æ•¸æ“šè¨ºæ–·</button>

    <div id="out" class="res-container">
        <div id="summary" class="summary-block">
            <div style="font-weight:bold; color:#e67e22; margin-bottom:8px;">ğŸ’¡ ç¶œåˆåˆ†æå»ºè­°</div>
            <div id="summaryText" style="font-size:15px; line-height:1.5; color:#5d4037; white-space: pre-wrap;"></div>
        </div>

        <div class="res-block">
            <div style="font-weight:bold; color:#007AFF; margin-bottom:12px;">ğŸ“Š X è»¸æ°´å¹³åˆ†æå ±å‘Š</div>
            <div class="stat-item"><span>æœ¬æ¬¡ EFI æŒ‡æ¨™</span><span id="rxE" class="efi-val"></span></div>
            <div id="cxE" class="stat-item" style="display:none;"><span>EFI è¶¨å‹¢</span><span id="dxE" class="stat-value"></span></div>
            <div class="stat-item"><span>ä¸­å¿ƒåç§»å¹³å‡</span><span id="offX" class="stat-value"></span></div>
            <div class="stat-item"><span>å‹•ä½œä¸€è‡´æ€§ (é›¢å·®)</span><span id="madX" class="stat-value"></span></div>
            <div id="cxM" class="stat-item" style="display:none;"><span>ä¸€è‡´æ€§è¶¨å‹¢</span><span id="dxM" class="stat-value"></span></div>
            <div class="stat-item"><span>æ¨£æœ¬èª¤å·®æ©Ÿç‡</span><span id="prX" class="stat-value"></span></div>
        </div>

        <div class="res-block">
            <div style="font-weight:bold; color:#007AFF; margin-bottom:12px;">ğŸ“Š Y è»¸å‚ç›´åˆ†æå ±å‘Š</div>
            <div class="stat-item"><span>æœ¬æ¬¡ EFI æŒ‡æ¨™</span><span id="ryE" class="efi-val"></span></div>
            <div id="cyE" class="stat-item" style="display:none;"><span>EFI è¶¨å‹¢</span><span id="dyE" class="stat-value"></span></div>
            <div class="stat-item"><span>ä¸­å¿ƒåç§»å¹³å‡</span><span id="offY" class="stat-value"></span></div>
            <div class="stat-item"><span>å‹•ä½œä¸€è‡´æ€§ (é›¢å·®)</span><span id="madY" class="stat-value"></span></div>
            <div id="cyM" class="stat-item" style="display:none;"><span>ä¸€è‡´æ€§è¶¨å‹¢</span><span id="dyM" class="stat-value"></span></div>
            <div class="stat-item"><span>æ¨£æœ¬èª¤å·®æ©Ÿç‡</span><span id="prY" class="stat-value"></span></div>
        </div>
    </div>
</div>

<script>
// --- é€™éƒ¨åˆ†æ˜¯ä½ çš„åŸå§‹é‚è¼¯ï¼Œæˆ‘çµ•å°ä¸å‹• ---
function coreCalc(raw, d, k) {
    const avg = raw.reduce((a, b) => a + b) / raw.length;
    const R = raw.filter(v => v >= avg), L = raw.filter(v => v < avg);
    const getM = (a) => {
        if (!a.length) return 0;
        const sA = a.reduce((p, c) => p + c) / a.length;
        return a.reduce((p, c) => p + Math.abs(c - sA), 0) / a.length;
    };
    const mR = getM(R), mL = getM(L);
    const dR = R.length ? Math.abs((R.reduce((a,b)=>a+b)/R.length)-avg) : 0;
    const dL = L.length ? Math.abs((L.reduce((a,b)=>a+b)/L.length)-avg) : 0;
    const pen = (k * dR) + (k * dL) + (k * (mR * R.length + mL * L.length) / raw.length);
    const efi = parseFloat((10 * ((d - pen) / d) + 1).toFixed(4));
    const mad = parseFloat(((R.length * mR) + (L.length * mL)) / raw.length);
    return { efi, mad, avg, mR, mL, nR: R.length, nL: L.length };
}

function runDiag() {
    const d = parseFloat(document.getElementById('faceSize').value);
    const k = parseFloat(document.getElementById('kValue').value);
    const xData = document.getElementById('inX').value.split(',').map(Number).filter(n => !isNaN(n));
    const yData = document.getElementById('inY').value.split(',').map(Number).filter(n => !isNaN(n));

    if (xData.length < 2 || yData.length < 2) return alert("è«‹è¼¸å…¥å®Œæ•´æ•¸æ“š");
    document.getElementById('out').style.display = 'block';

    const resX = coreCalc(xData, d, k);
    const resY = coreCalc(yData, d, k);

    // Xè»¸é¡¯ç¤º
    document.getElementById('rxE').innerText = resX.efi;
    document.getElementById('offX').innerText = `${resX.avg.toFixed(2)} cm ${resX.avg < 0 ? "(åå·¦)" : "(åå³)"}`;
    document.getElementById('madX').innerText = resX.mad.toFixed(2);
    const exX = resX.mR >= resX.mL ? {s:"å³å´", n:resX.nR} : {s:"å·¦å´", n:resX.nL};
    document.getElementById('prX').innerText = `${((exX.n/12)*100).toFixed(0)}% (${exX.s})`;

    // Yè»¸é¡¯ç¤º
    document.getElementById('ryE').innerText = resY.efi;
    document.getElementById('offY').innerText = `${resY.avg.toFixed(2)} cm ${resY.avg < 0 ? "(åä¸Š)" : "(åä¸‹)"}`;
    document.getElementById('madY').innerText = resY.mad.toFixed(2);
    const exY = resY.mR >= resY.mL ? {s:"ä¸Šå´", n:resY.nR} : {s:"ä¸‹å´", n:resY.nL};
    document.getElementById('prY').innerText = `${((exY.n/12)*100).toFixed(0)}% (${exY.s})`;

    // è¶¨å‹¢æ¯”å°é‚è¼¯ (ä¸å‹•)
    const compare = (curE, prevE, idRow, idVal) => {
        if(!isNaN(prevE)) {
            document.getElementById(idRow).style.display = 'flex';
            const df = curE - prevE;
            document.getElementById(idVal).innerHTML = df>=0 ? `<span class="trend-up">â†‘ æå‡ ${df.toFixed(4)}</span>` : `<span class="trend-down">â†“ ä¸‹é™ ${Math.abs(df).toFixed(4)}</span>`;
        }
    };
    const compareM = (curM, prevM, idRow, idVal) => {
        if(!isNaN(prevM)) {
            document.getElementById(idRow).style.display = 'flex';
            const df = curM - prevM;
            document.getElementById(idVal).innerHTML = df<0 ? `<span class="trend-up">é€²æ­¥ (ç¸®å° ${Math.abs(df).toFixed(2)})</span>` : `<span class="trend-down">åŠ æ²¹ (æ”¾å¤§ ${df.toFixed(2)})</span>`;
        }
    };
    compare(resX.efi, parseFloat(document.getElementById('pxE').value), 'cxE', 'dxE');
    compareM(resX.mad, parseFloat(document.getElementById('pxM').value), 'cxM', 'dxM');
    compare(resY.efi, parseFloat(document.getElementById('pyE').value), 'cyE', 'dyE');
    compareM(resY.mad, parseFloat(document.getElementById('pyM').value), 'cyM', 'dyM');

    // --- ä»¥ä¸‹ç‚ºä¿®æ­£å¾Œçš„å¤–æ›å»ºè­°å€ ---
    let summary = "";
    if (resX.efi < resY.efi) {
        summary = "âš ï¸ æ³¨æ„ X è»¸ (æ°´å¹³)ï¼šæ°´å¹³ EFI è¼ƒä½ï¼Œè«‹å„ªå…ˆæª¢æŸ¥æ”¾å¼¦ã€å¾Œæ‰‹è§’åº¦ä¸€è‡´æ€§ã€å¼¦å½±æˆ–æ¨é»ç¢ºèªã€‚";
    } else if (resY.efi < resX.efi) {
        summary = "âš ï¸ æ³¨æ„ Y è»¸ (å‚ç›´)ï¼šå‚ç›´ EFI è¼ƒä½ï¼Œè«‹æª¢æŸ¥æ¨å¼“æ‰‹å£“åŠ›é»æ˜¯å¦ç©©å®šã€é å¼¦ä½ç½®ã€å‰è‚©ç©©å®šã€‚";
    } else {
        summary = "âœ… é›™è»¸å¹³è¡¡ï¼šç›®å‰å™¨æè¨­å®šåœ¨å…©å€‹ç¶­åº¦è¡¨ç¾å‡ç­‰ã€‚";
    }

    // ä¿®æ­£ï¼šåå·¦å°±èª¿å·¦ï¼Œåå³å°±èª¿å³ï¼›åä¸Šå°±èª¿ä¸Šï¼Œåä¸‹å°±èª¿ä¸‹
    const adjX = resX.avg < 0 ? "å·¦" : "å³";
    const adjY = resY.avg < 0 ? "ä¸Š" : "ä¸‹";

    const bestX = resX.mR < resX.mL ? "å³å´" : "å·¦å´";
    const bestY = resY.mR < resY.mL ? "ä¸Šå´" : "ä¸‹å´";

    summary += `\n\nğŸ› ï¸ **ç„æº–å™¨æ–¹å‘å¾®èª¿å»ºè­°**ï¼š\nè«‹å°‡ç„æº–å™¨å‘ã€${adjX}ã€‘ä¸”å‘ã€${adjY}ã€‘æ’¥å‹•ã€‚`;
    summary += `\n\nâœ¨ **è¼ƒç²¾æº–çš„å‹•ä½œè¡¨ç¾å´**ï¼š\næ°´å¹³æ–¹å‘ä»¥ã€${bestX}ã€‘è¼ƒç©©ï¼Œå‚ç›´æ–¹å‘ä»¥ã€${bestY}ã€‘è¼ƒç©©ã€‚è«‹å›æƒ³ä¸¦ä¿æŒè©²å´ç™¼åŠ›æ„Ÿã€‚`;

    document.getElementById('summaryText').innerText = summary;
}
</script>
</body>
</html>
<script>
(function() {
    const STORAGE_KEY = 'archery_history_list';

    window.addEventListener('load', function() {
        const mainBtn = document.querySelector('button[onclick="runDiag()"]');
        if (!mainBtn) return;

        const pluginContainer = document.createElement('div');
        pluginContainer.style = "margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 1px solid #ddd;";
        
        // ä¿®æ­£é»ï¼šåœ¨æŒ‰éˆ• style åŠ å…¥ display:flex; align-items:center; justify-content:center;
        pluginContainer.innerHTML = `
            <div style="font-weight:bold; font-size:14px; margin-bottom:10px; color:#555;">ğŸ’¾ æ­·å²ç´€éŒ„ç®¡ç†</div>
            <button id="p_btnSave" style="width:100%; padding:0; height:48px; background:#28a745; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; margin-bottom:12px; font-size:16px; display:flex; align-items:center; justify-content:center;">ğŸ•’ ä»¥ç•¶å‰æ™‚é–“å„²å­˜æ•¸æ“š</button>
            
            <div style="display:flex; gap:8px; align-items: center;">
                <select id="p_recordSelect" style="flex:1.2; padding:0 10px; border-radius:8px; border:1px solid #ccc; height:48px; font-size:14px; background:white;"></select>
                <button id="p_btnLoad" style="flex:2; height:48px; background:#6f42c1; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:15px; display:flex; align-items:center; justify-content:center;">è¼‰å…¥ç´€éŒ„</button>
                <button id="p_btnDel" style="width:55px; height:48px; background:#dc3545; color:white; border:none; border-radius:8px; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center;">åˆªé™¤</button>
            </div>
        `;
        mainBtn.parentNode.insertBefore(pluginContainer, mainBtn.nextSibling);

        const recordSelect = document.getElementById('p_recordSelect');

        const updateDropdown = () => {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            recordSelect.innerHTML = '<option value="">ç´€éŒ„</option>';
            Object.keys(history).sort().reverse().forEach(time => {
                const opt = document.createElement('option');
                opt.value = time;
                opt.innerText = time;
                recordSelect.appendChild(opt);
            });
        };

        document.getElementById('p_btnSave').onclick = function() {
            const now = new Date();
            const timeKey = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            const currentData = {
                pxE: document.getElementById('pxE').value, pxM: document.getElementById('pxM').value, inX: document.getElementById('inX').value,
                pyE: document.getElementById('pyE').value, pyM: document.getElementById('pyM').value, inY: document.getElementById('inY').value,
                k: document.getElementById('kValue').value
            };
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            history[timeKey] = currentData;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            updateDropdown();
            alert('âœ… å·²å­˜ç‚ºï¼š' + timeKey);
        };

        document.getElementById('p_btnLoad').onclick = function() {
            const timeKey = recordSelect.value;
            if (!timeKey) return alert('è«‹é¸æ“‡ç´€éŒ„');
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const d = history[timeKey];
            if (d) {
                document.getElementById('pxE').value = d.pxE; document.getElementById('pxM').value = d.pxM; document.getElementById('inX').value = d.inX;
                document.getElementById('pyE').value = d.pyE; document.getElementById('pyM').value = d.pyM; document.getElementById('inY').value = d.inY;
                document.getElementById('kValue').value = d.k;
                alert('ğŸ“‚ è¼‰å…¥æˆåŠŸ');
            }
        };

        document.getElementById('p_btnDel').onclick = function() {
            const timeKey = recordSelect.value;
            if (!timeKey) return alert('è«‹é¸æ“‡');
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                delete history[timeKey];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
                updateDropdown();
            }
        };

        updateDropdown();

        const originalRunDiag = window.runDiag;
        window.runDiag = function() {
            originalRunDiag();
            const summaryText = document.getElementById('summaryText');
            if (summaryText) {
                const now = new Date();
                const timeStr = `\n\nğŸ•’ è¨ºæ–·æ™‚é–“ï¼š${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                if (!summaryText.innerText.includes('ğŸ•’ è¨ºæ–·æ™‚é–“')) {
                    summaryText.innerText += timeStr;
                } else {
                    summaryText.innerText = summaryText.innerText.replace(/ğŸ•’ è¨ºæ–·æ™‚é–“ï¼š.*/, `ğŸ•’ è¨ºæ–·æ™‚é–“ï¼š${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`);
                }
            }
        };
    });
})();
</script>

<script>
(function() {
    window.addEventListener('load', function() {
        // 1. å°‹æ‰¾æ’å…¥é» (æ’åœ¨ "X è»¸æ°´å¹³åº§æ¨™cm" æ¨™é¡Œä¹‹å‰)
        const allSectionTitles = document.querySelectorAll('.section-title');
        let xSectionTitle = null;
        for (let i = 0; i < allSectionTitles.length; i++) {
            if (allSectionTitles[i].innerText.includes('X è»¸æ°´å¹³åº§æ¨™')) {
                xSectionTitle = allSectionTitles[i];
                break;
            }
        }
        
        if (!xSectionTitle) return; // æ‰¾ä¸åˆ°æ’å…¥é»å‰‡è·³é

        // 2. å»ºç«‹ UI çµæ§‹
        const targetContainer = document.createElement('div');
        targetContainer.style = "margin: 20px 0; padding: 15px; background: #fff; border: 2px dashed #007AFF; border-radius: 12px; text-align: center;";
        
        const uiHtml = `
            <div style="font-weight:bold; color:#007AFF; margin-bottom:10px;">ğŸ¯ è§¸æ§é¶ç´™è¼¸å…¥ (é»æ“Šå³è¨˜éŒ„)</div>
            <div style="position: relative; display: inline-block; width: 300px; height: 300px;">
                <canvas id="targetCanvas" width="300" height="300" style="width:100%; height:100%; border-radius:50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); touch-action: none; cursor: crosshair;"></canvas>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center;">
                <button id="btnUndoShot" style="width: auto; margin-top:0; padding: 8px 15px; font-size: 14px; background: #6c757d;">â†©ï¸ å¾©åŸä¸€ç®­</button>
                <button id="btnClearShots" style="width: auto; margin-top:0; padding: 8px 15px; font-size: 14px; background: #dc3545;">ğŸ—‘ï¸ æ¸…ç©º</button>
            </div>
            <div style="font-size: 13px; color: #666; margin-top: 5px;">å·²è¨˜éŒ„: <span id="shotCounter" style="font-weight:bold; color:#007AFF;">0</span> / 12 ç®­</div>
            <div style="font-size: 12px; color: #999; margin-top: 2px;">åœ“å¿ƒç‚º(0,0)ï¼Œå³+/å·¦-ï¼Œä¸Š+/ä¸‹-</div>
        `;
        targetContainer.innerHTML = uiHtml;
        
        // æ’å…¥åˆ° DOM
        xSectionTitle.parentNode.insertBefore(targetContainer, xSectionTitle);

        // 3. Canvas ç¹ªåœ–é‚è¼¯
        const canvas = document.getElementById('targetCanvas');
        const ctx = canvas.getContext('2d');
        const shotCounter = document.getElementById('shotCounter');
        let shots = []; // å„²å­˜ {x: cm, y: cm}

        function drawTarget() {
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const radius = canvas.width / 2;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç¹ªè£½åŒå¿ƒåœ“ (æ¨¡æ“¬é¶ç´™) - ç°¡åŒ–ç‰ˆ 5è‰²
            const colors = ['white', 'black', '#33adff', '#ff3333', '#ffe600']; // 1-2, 3-4, 5-6, 7-8, 9-10
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.arc(cx, cy, radius * ((5 - i) / 5), 0, 2 * Math.PI);
                ctx.fillStyle = colors[i];
                ctx.fill();
                ctx.strokeStyle = '#ddd';
                ctx.stroke();
            }
            
            // ç¹ªè£½åå­—ç·š
            ctx.beginPath();
            ctx.moveTo(cx, 0); ctx.lineTo(cx, canvas.height);
            ctx.moveTo(0, cy); ctx.lineTo(canvas.width, cy);
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.stroke();

            // ç¹ªè£½è½é»
            shots.forEach((shot, index) => {
                // å°‡ cm è½‰å› canvas åƒç´ 
                const faceSize = parseFloat(document.getElementById('faceSize').value) || 80;
                const scale = faceSize / canvas.width; // cm per pixel
                
                const pixelX = cx + (shot.x / scale);
                const pixelY = cy - (shot.y / scale); // Yè»¸åè½‰å›ä¾†ç¹ªåœ–
                
                ctx.beginPath();
                ctx.arc(pixelX, pixelY, 4, 0, 2 * Math.PI);
                ctx.fillStyle = '#00ff00'; // ç¶ è‰²è½é»
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.stroke();
                
                // æ¨™ç¤ºåºè™Ÿ
                ctx.fillStyle = 'black';
                ctx.font = '10px Arial';
                ctx.fillText(index + 1, pixelX + 6, pixelY + 4);
            });

            shotCounter.innerText = shots.length;
        }

        // 4. æ›´æ–°è¼¸å…¥æ¡†é‚è¼¯
        function updateInputs() {
            const xStr = shots.map(s => s.x.toFixed(2)).join(',');
            const yStr = shots.map(s => s.y.toFixed(2)).join(',');
            
            document.getElementById('inX').value = xStr;
            document.getElementById('inY').value = yStr;
        }

        // 5. é»æ“Šè™•ç†
        canvas.addEventListener('pointerdown', function(e) { // ä½¿ç”¨ pointerdown æ”¯æ´æ‰‹æ©Ÿè§¸æ§
            if (shots.length >= 12) {
                alert('æœ€å¤šè¨˜éŒ„ 12 ç®­ï¼Œè«‹å…ˆæ¸…ç©ºæˆ–å¾©åŸã€‚');
                return;
            }

            const rect = canvas.getBoundingClientRect();
            // è¨ˆç®—é»æ“Šä½ç½® (ç›¸å°æ–¼ canvas å·¦ä¸Šè§’)
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            
            // ç”±æ–¼ canvas æ¨£å¼å¯¬é«˜å¯èƒ½è·Ÿå¯¦éš›å±¬æ€§å¯¬é«˜ä¸åŒ (éŸ¿æ‡‰å¼ç¸®æ”¾)ï¼Œéœ€æ ¡æ­£
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const finalX = clickX * scaleX;
            const finalY = clickY * scaleY;

            // è½‰æ›ç‚ºåº§æ¨™ç³» (åœ“å¿ƒ 0,0)
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            
            const dx_px = finalX - cx;
            const dy_px = cy - finalY; // Canvas Y å‘ä¸‹ï¼Œåº§æ¨™ç³» Y å‘ä¸Šï¼Œæ•…åè½‰

            // è½‰æ›ç‚ºå…¬åˆ† (æ ¹æ“šé¸æ“‡çš„é¶ç´™å°ºå¯¸)
            const faceSize = parseFloat(document.getElementById('faceSize').value) || 80;
            // å‡è¨­ canvas å¯¬åº¦æ»¿ç‰ˆä»£è¡¨é¶ç´™ç›´å¾‘
            const cmPerPixel = faceSize / canvas.width;
            
            const cmX = dx_px * cmPerPixel;
            const cmY = dy_px * cmPerPixel;

            shots.push({ x: cmX, y: cmY });
            
            drawTarget();
            updateInputs();
            
            // ç°¡å–®éœ‡å‹•å›é¥‹ (è‹¥è£ç½®æ”¯æ´)
            if (navigator.vibrate) navigator.vibrate(50);
            
            e.preventDefault(); // é˜²æ­¢æ»¾å‹•
        });

        // 6. æŒ‰éˆ•äº‹ä»¶
        document.getElementById('btnUndoShot').addEventListener('click', function() {
            shots.pop();
            drawTarget();
            updateInputs();
        });

        document.getElementById('btnClearShots').addEventListener('click', function() {
            if (confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è½é»ï¼Ÿ')) {
                shots = [];
                drawTarget();
                updateInputs();
            }
        });

        // åˆå§‹ç¹ªè£½
        drawTarget();
        
        // ç•¶é¶ç´™å°ºå¯¸æ”¹è®Šæ™‚ï¼Œé‡ç¹ª (é›–ç„¶åº§æ¨™ä¸è®Šï¼Œä½†è‹¥æœ‰å·²å­˜é»ä½é‚è¼¯ä¸Šé€šå¸¸åº§æ¨™å€¼å›ºå®šï¼Œè¦–è¦ºæ¯”ä¾‹æœƒè®Šï¼Œé€™è£¡ç°¡åŒ–ç‚ºé‡ç¹ªå³å¯)
        document.getElementById('faceSize').addEventListener('change', drawTarget);
    });
})();
</script>
<script>
(function() {
    // ç­‰å¾…é é¢è¼‰å…¥å®Œæˆ
    window.addEventListener('load', function() {
        
        // 1. å°‹æ‰¾æ’å…¥é» (æ’åœ¨ "X è»¸æ°´å¹³åº§æ¨™cm" æ¨™é¡Œä¹‹å‰)
        const allSectionTitles = document.querySelectorAll('.section-title');
        let xSectionTitle = null;
        for (let i = 0; i < allSectionTitles.length; i++) {
            if (allSectionTitles[i].innerText.includes('X è»¸æ°´å¹³åº§æ¨™')) {
                xSectionTitle = allSectionTitles[i];
                break;
            }
        }
        if (!xSectionTitle) return;

        // 2. å»ºç«‹ UI çµæ§‹ (åŒ…å«ä¸»ç•«å¸ƒèˆ‡éš±è—çš„æ”¾å¤§é¡)
        const targetContainer = document.createElement('div');
        targetContainer.style = "margin: 20px 0; padding: 10px; background: #fff; border: 2px dashed #007AFF; border-radius: 12px; text-align: center; position: relative; touch-action: none;";
        
        const uiHtml = `
            <div style="font-weight:bold; color:#007AFF; margin-bottom:10px;">ğŸ¯ è§¸æ§é¶ç´™è¼¸å…¥ (æ‹–æ›³ç„æº–)</div>
            
            <div id="canvasWrapper" style="position: relative; display: inline-block; width: 300px; height: 300px;">
                <canvas id="targetCanvas" width="300" height="300" style="width:100%; height:100%; border-radius:50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: crosshair;"></canvas>
                
                <div id="loupe" style="
                    display: none;
                    position: absolute;
                    width: 100px;
                    height: 100px;
                    border: 3px solid #333;
                    border-radius: 50%;
                    background: #fff;
                    overflow: hidden;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    pointer-events: none; /* è®“äº‹ä»¶ç©¿é€æ”¾å¤§é¡ */
                    z-index: 100;
                ">
                    <canvas id="loupeCanvas" width="200" height="200" style="width:100%; height:100%;"></canvas>
                    <div style="position:absolute; top:50%; left:0; width:100%; height:1px; background:rgba(255,0,0,0.8);"></div>
                    <div style="position:absolute; top:0; left:50%; width:1px; height:100%; background:rgba(255,0,0,0.8);"></div>
                </div>
            </div>

            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <button id="btnUndoShot" style="width: auto; margin-top:0; padding: 8px 15px; font-size: 14px; background: #6c757d; color:white; border:none; border-radius:8px;">â†©ï¸ å¾©åŸ</button>
                <button id="btnClearShots" style="width: auto; margin-top:0; padding: 8px 15px; font-size: 14px; background: #dc3545; color:white; border:none; border-radius:8px;">ğŸ—‘ï¸ æ¸…ç©º</button>
            </div>
            <div style="font-size: 13px; color: #666; margin-top: 8px;">å·²è¨˜éŒ„: <span id="shotCounter" style="font-weight:bold; color:#007AFF;">0</span> / 12 ç®­</div>
            <div style="font-size: 12px; color: #999; margin-top: 2px;">é•·æŒ‰æ‹–æ›³ä»¥ç²¾æº–å®šä½ï¼Œæ”¾é–‹å³è¨˜éŒ„</div>
        `;
        targetContainer.innerHTML = uiHtml;
        xSectionTitle.parentNode.insertBefore(targetContainer, xSectionTitle);

        // 3. è®Šæ•¸èˆ‡ Canvas è¨­å®š
        const canvas = document.getElementById('targetCanvas');
        const ctx = canvas.getContext('2d');
        const loupe = document.getElementById('loupe');
        const loupeCanvas = document.getElementById('loupeCanvas');
        const lCtx = loupeCanvas.getContext('2d');
        const shotCounter = document.getElementById('shotCounter');
        
        let shots = []; // {x: cm, y: cm}
        let isDragging = false;
        let currentTouch = { x: 0, y: 0 }; // ç•¶å‰æ‰‹æŒ‡ä½ç½® (åƒç´ )

        // 4. ç¹ªè£½é¶ç´™å‡½æ•¸ (å…±ç”¨)
        function drawFace(context, width, height, withShots = true) {
            const cx = width / 2;
            const cy = height / 2;
            const radius = width / 2;
            
            // æ¸…ç©º
            context.clearRect(0, 0, width, height);
            
            // å®šç¾©è‰²ç’° (ç”±å¤–è€Œå…§: 1-2ç™½, 3-4é»‘, 5-6è—, 7-8ç´…, 9-10é»ƒ)
            // æ¨™æº–é¶æ¯ç’°å¯¬åº¦ç›¸ç­‰ã€‚åŠå¾‘ç‚º Rã€‚
            // 1åˆ†ç’°åŠå¾‘ = R, 2åˆ†ç’° = 0.9R ... 10åˆ†ç’° = 0.1R
            const rings = [
                {color: 'white', r: 1.0},   // 1
                {color: 'white', r: 0.9},   // 2
                {color: 'black', r: 0.8},   // 3
                {color: 'black', r: 0.7},   // 4
                {color: '#00B4F0', r: 0.6}, // 5 (Blue)
                {color: '#00B4F0', r: 0.5}, // 6
                {color: '#FF3333', r: 0.4}, // 7 (Red)
                {color: '#FF3333', r: 0.3}, // 8
                {color: '#FFE600', r: 0.2}, // 9 (Yellow)
                {color: '#FFE600', r: 0.1}, // 10
                {color: '#FFE600', r: 0.05} // X (Inner 10) - é€™è£¡ç”¨ 0.05 æ¨¡æ“¬ X åœˆ
            ];

            rings.forEach((ring, idx) => {
                context.beginPath();
                context.arc(cx, cy, radius * ring.r, 0, 2 * Math.PI);
                context.fillStyle = ring.color;
                context.fill();
                // ç•«ç·š (Xåœˆç´°ä¸€é»ï¼Œå…¶ä»–æ¨™æº–ç·š)
                context.lineWidth = (idx === rings.length - 1) ? 0.5 : 1;
                context.strokeStyle = (ring.color === 'black') ? 'white' : '#999'; 
                context.stroke();
            });

            // ç•«åå­—ä¸­å¿ƒç·š
            context.beginPath();
            context.moveTo(cx - 5, cy); context.lineTo(cx + 5, cy);
            context.moveTo(cx, cy - 5); context.lineTo(cx, cy + 5);
            context.lineWidth = 1;
            context.strokeStyle = 'black';
            context.stroke();

            // ç¹ªè£½å·²å­˜åœ¨çš„è½é» (åƒ…åœ¨ä¸»ç•«å¸ƒç¹ªè£½ï¼Œæ”¾å¤§é¡é‡ç¹ªæ™‚æœƒåŒ…å«)
            if (withShots) {
                // éœ€è¦é‡æ–°è¨ˆç®—åƒç´ ä½ç½®
                const faceSize = parseFloat(document.getElementById('faceSize').value) || 80;
                const pxPerCm = width / faceSize; 

                shots.forEach((s, i) => {
                    const px = cx + (s.x * pxPerCm);
                    const py = cy - (s.y * pxPerCm); // Yåè½‰

                    context.beginPath();
                    context.arc(px, py, width * 0.015, 0, 2 * Math.PI); // é»çš„å¤§å°éš¨ç•«å¸ƒç¸®æ”¾
                    context.fillStyle = '#00CC00'; // é®®ç¶ è‰²è½é»
                    context.fill();
                    context.strokeStyle = 'white';
                    context.lineWidth = 1;
                    context.stroke();
                    
                    // åºè™Ÿ
                    context.fillStyle = 'black';
                    context.font = 'bold ' + (width * 0.04) + 'px Arial';
                    context.fillText(i + 1, px + (width*0.02), py);
                });
            }
        }

        // 5. æ›´æ–°è¼¸å…¥æ¡† (å°æ•¸é»ä¸€ä½)
        function updateInputs() {
            // map(s => s.x.toFixed(1)) ç¢ºä¿åªæœ‰ä¸€ä½å°æ•¸
            const xStr = shots.map(s => s.x.toFixed(1)).join(',');
            const yStr = shots.map(s => s.y.toFixed(1)).join(',');
            
            document.getElementById('inX').value = xStr;
            document.getElementById('inY').value = yStr;
            shotCounter.innerText = shots.length;
        }

        // 6. äº’å‹•é‚è¼¯ (æ ¸å¿ƒï¼šæ”¾å¤§é¡èˆ‡æ‹–æ›³)
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            // å…¼å®¹ Mouse èˆ‡ Touch
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            // è™•ç† Canvas CSS ç¸®æ”¾å°è‡´çš„åº§æ¨™åç§»
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY,
                cssX: (clientX - rect.left), // ç”¨æ–¼å®šä½æ”¾å¤§é¡ DOM
                cssY: (clientY - rect.top)
            };
        }

        // è§¸æ§é–‹å§‹
        function onPointerDown(e) {
            if (shots.length >= 12) {
                alert('å·²æ»¿ 12 ç®­ï¼Œè«‹å…ˆæ¸…ç©ºæˆ–å¾©åŸã€‚');
                return;
            }
            e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿæ»¾å‹•
            isDragging = true;
            
            const pos = getCanvasCoordinates(e);
            currentTouch = pos;
            
            // é¡¯ç¤ºæ”¾å¤§é¡
            loupe.style.display = 'block';
            updateLoupe(pos);
        }

        // è§¸æ§ç§»å‹•
        function onPointerMove(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            const pos = getCanvasCoordinates(e);
            currentTouch = pos;
            updateLoupe(pos);
        }

        // è§¸æ§çµæŸ (ç¢ºå®šè½é»)
        function onPointerUp(e) {
            if (!isDragging) return;
            isDragging = false;
            loupe.style.display = 'none'; // éš±è—æ”¾å¤§é¡

            // è¨ˆç®—æœ€çµ‚åº§æ¨™ (cm)
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const faceSize = parseFloat(document.getElementById('faceSize').value) || 80;
            const cmPerPixel = faceSize / canvas.width;

            const cmX = (currentTouch.x - cx) * cmPerPixel;
            const cmY = (cy - currentTouch.y) * cmPerPixel; // Yåè½‰

            shots.push({ x: cmX, y: cmY });
            
            drawFace(ctx, canvas.width, canvas.height); // é‡ç¹ªä¸»ç•«å¸ƒ(å«æ–°é»)
            updateInputs();
            
            // éœ‡å‹•å›é¥‹
            if (navigator.vibrate) navigator.vibrate(30);
        }

        // æ›´æ–°æ”¾å¤§é¡å…§å®¹
        function updateLoupe(pos) {
            // 1. ç§»å‹•æ”¾å¤§é¡ DOM ä½ç½® (è®“å®ƒå‡ºç¾åœ¨æ‰‹æŒ‡ä¸Šæ–¹ï¼Œé¿å…æ“‹ä½)
            // æ¸›å»åç§»é‡ï¼Œè®“æ”¾å¤§é¡æµ®åœ¨æ‰‹æŒ‡ä¸Šæ–¹
            loupe.style.left = (pos.cssX - 50) + 'px'; // 50æ˜¯å¯¬åº¦ä¸€åŠ
            loupe.style.top = (pos.cssY - 120) + 'px'; // 120è®“å®ƒæµ®åœ¨æ‰‹æŒ‡ä¸Šæ–¹ä¸€æ®µè·é›¢

            // 2. ç¹ªè£½æ”¾å¤§é¡å…§çš„ Canvas
            // æˆ‘å€‘éœ€è¦ç•«ä¸€å€‹ã€Œç•¶å‰ä¸»ç•«å¸ƒçš„å±€éƒ¨æ”¾å¤§ç‰ˆã€
            // ç‚ºäº†ä¸ç•«åˆ°ã€Œé‚„æ²’ç¢ºå®šã€çš„é‚£å€‹ç¶ é»ï¼Œæˆ‘å€‘é‡æ–°ç•«ä¸€æ¬¡ä¹¾æ·¨çš„é¶é¢åœ¨ loupeCanvas ä¸Š
            
            // æŠ€å·§ï¼šå…ˆåœ¨æ”¾å¤§é¡è£¡ç•«æ•´å€‹ä¹¾æ·¨é¶é¢
            // ä½†é€™æ¨£æ•ˆèƒ½ä¸å¥½ã€‚æ›´å¥½çš„æ–¹å¼ï¼š
            // ç›´æ¥ç•«èƒŒæ™¯ï¼Œç„¶å¾Œç§»å‹• context è®“ã€Œæ‰‹æŒ‡ä½ç½®ã€è®Šæˆã€Œæ”¾å¤§é¡ä¸­å¿ƒã€
            
            const zoom = 2.5; // æ”¾å¤§å€ç‡
            
            // æ¸…é™¤æ”¾å¤§é¡
            lCtx.clearRect(0, 0, loupeCanvas.width, loupeCanvas.height);
            
            lCtx.save();
            // ç§»å‹•åŸé»åˆ°æ”¾å¤§é¡ä¸­å¿ƒ
            lCtx.translate(loupeCanvas.width/2, loupeCanvas.height/2);
            // ç¸®æ”¾
            lCtx.scale(zoom, zoom);
            // åå‘ç§»å‹•ï¼Œå°‡æ‰‹æŒ‡åœ¨ä¸»ç•«å¸ƒçš„ä½ç½®ç§»åˆ°åŸé»
            lCtx.translate(-pos.x, -pos.y);
            
            // åœ¨æ”¾å¤§é¡è£¡é‡ç¹ªæ•´å€‹é¶é¢å’ŒèˆŠçš„é»
            drawFace(lCtx, canvas.width, canvas.height, true);
            
            lCtx.restore();
        }

        // ç¶å®šäº‹ä»¶ (æ”¯æ´ Touch èˆ‡ Mouse)
        canvas.addEventListener('touchstart', onPointerDown, {passive: false});
        canvas.addEventListener('touchmove', onPointerMove, {passive: false});
        canvas.addEventListener('touchend', onPointerUp);
        canvas.addEventListener('touchcancel', onPointerUp);
        
        // æ»‘é¼ æ”¯æ´ (é›»è…¦ç‰ˆæ¸¬è©¦ç”¨)
        canvas.addEventListener('mousedown', onPointerDown);
        window.addEventListener('mousemove', onPointerMove);
        window.addEventListener('mouseup', onPointerUp);

        // æŒ‰éˆ•äº‹ä»¶
        document.getElementById('btnUndoShot').addEventListener('click', function() {
            shots.pop();
            drawFace(ctx, canvas.width, canvas.height);
            updateInputs();
        });

        document.getElementById('btnClearShots').addEventListener('click', function() {
            if (confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è½é»ï¼Ÿ')) {
                shots = [];
                drawFace(ctx, canvas.width, canvas.height);
                updateInputs();
            }
        });
        
        // åˆå§‹ç¹ªè£½
        drawFace(ctx, canvas.width, canvas.height);
        
        // ç•¶åˆ‡æ›é¶ç´™å°ºå¯¸æ™‚ï¼Œæ›´æ–° (ä¸éœ€é‡ç¹ªï¼Œå› ç‚ºåœ–å½¢æ¯”ä¾‹ä¸è®Šï¼Œæ˜¯è¨ˆç®—é‚è¼¯è®Š)
        document.getElementById('faceSize').addEventListener('change', function(){
            drawFace(ctx, canvas.width, canvas.height);
            // è‹¥åˆ‡æ›å°ºå¯¸ï¼Œç†è«–ä¸Šå·²æœ‰é»ä½çš„ä½ç½®cmä¸è®Šï¼Œä½†è¦–è¦ºä½ç½®æœƒè®Šï¼Ÿ
            // é€™è£¡é‚è¼¯ç¶­æŒï¼šé»ä¸‹å»çš„ä½ç½®å°æ‡‰çš„cmæ˜¯å›ºå®šçš„ã€‚
        });
    });
})();
</script>
